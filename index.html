<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Prompts (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e0e0e0; }
        .sidebar { transition: width 0.3s ease-in-out; }
        .sidebar-collapsed { width: 0; padding: 0; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2c2c2c; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        
        /* Estilos generales de items */
        .prompt-card, .folder-item-header { border: 1px solid #333; transition: all 0.2s ease; }
        .prompt-card:hover, .folder-item-header:hover { border-color: #555; background-color: #252525; }
        
        /* Drag and Drop */
        .ghost { opacity: 0.4; background: #3a3a3a; }
        .drag-over-folder { border-color: #3b82f6 !important; background-color: rgba(59, 130, 246, 0.2) !important; }
        
        /* Vista de Cuadrícula */
        .prompts-grid-view .prompt-card { height: 11rem; }
        
        /* Vista de Lista */
        .prompts-list-view { display: flex; flex-direction: column; gap: 0.5rem; }
        .prompts-list-view .prompt-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            height: auto;
            padding: 0.75rem 1rem;
        }
        .prompts-list-view .prompt-card-content { flex-grow: 1; overflow: hidden; }
        .prompts-list-view .prompt-title { white-space: nowrap; }
        .prompts-list-view .prompt-text { display: none; } /* Ocultamos el texto en la vista de lista */
        .prompts-list-view .prompt-actions { margin-top: 0; }

        /* Carpetas Desplegables */
        .folder-chevron { transition: transform 0.2s ease-in-out; }
        .is-expanded .folder-chevron { transform: rotate(90deg); }
        .folder-prompts-list { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .is-expanded .folder-prompts-list { max-height: 500px; } /* Altura máxima para la animación */
        .prompt-title-in-folder {
            padding: 6px 6px 6px 32px; /* Indentación */
            font-size: 0.8rem;
            color: #a0a0a0;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .prompt-title-in-folder:hover { background-color: #2a2a2a; color: #ffffff; }

        /* Modales y otros */
        .color-picker input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; padding: 0; border-radius: 50%; cursor: pointer; }
        .color-picker input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        .editable-input { background: #333; border: 1px solid #555; color: #e0e0e0; padding: 4px 8px; border-radius: 6px; width: 100%; }
        .view-mode-btn.active { color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app" class="flex h-screen">
        <aside id="sidebar" class="sidebar bg-[#161616] w-72 h-full flex flex-col p-4 border-r border-[#2a2a2a]">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-xl font-bold text-white">Carpetas</h1>
                <div class="flex items-center">
                    <button id="add-folder-btn" class="p-1 text-gray-400 hover:text-white transition-colors" title="Nueva Carpeta"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
                    <button id="delete-folder-btn" class="p-1 text-gray-400 hover:text-red-400 transition-colors ml-2" title="Eliminar Carpeta"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div id="folder-list" class="flex-grow overflow-y-auto pr-2"></div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#1a1a1a]">
            <header class="flex items-center p-4 border-b border-[#2a2a2a] bg-[#161616]">
                <button id="toggle-sidebar-btn" class="p-2 mr-4 text-gray-400 hover:text-white"><i data-lucide="panel-left" class="w-5 h-5"></i></button>
                <div class="flex-1 relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"></i>
                    <input type="text" id="search-input" placeholder="Buscar en esta carpeta..." class="w-full bg-[#2a2a2a] border border-[#3a3a3a] rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center ml-4">
                    <button id="view-grid-btn" class="view-mode-btn p-2 text-gray-400 hover:text-white transition-colors rounded-md"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
                    <button id="view-list-btn" class="view-mode-btn p-2 text-gray-400 hover:text-white transition-colors rounded-md"><i data-lucide="list" class="w-5 h-5"></i></button>
                    <div class="h-6 w-px bg-gray-700 mx-2"></div>
                    <button id="sort-prompts-btn" class="flex items-center gap-2 p-2 mr-2 text-gray-400 hover:text-white transition-colors rounded-md"><i data-lucide="arrow-down-a-z" class="w-5 h-5"></i><span class="hidden sm:inline">Ordenar</span></button>
                    <button id="add-prompt-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors"><i data-lucide="plus" class="w-5 h-5"></i><span class="hidden sm:inline">Nuevo Prompt</span></button>
                </div>
            </header>

            <div id="prompts-container" class="flex-1 p-6 overflow-y-auto">
                <h2 id="current-folder-title" class="text-2xl font-bold mb-6 text-white"></h2>
                <div id="prompts-grid"></div>
                <div id="no-prompts-message" class="hidden text-center text-gray-500 mt-16"><i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4"></i><p class="text-lg">Esta carpeta está vacía.</p><p>Crea un nuevo prompt para empezar.</p></div>
                 <div id="no-folder-selected-message" class="text-center text-gray-500 mt-16"><i data-lucide="folder-open" class="w-16 h-16 mx-auto mb-4"></i><p class="text-lg">Selecciona o crea una carpeta</p><p>Tus prompts se organizan en carpetas.</p></div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300"></div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-[#2a2a2a] rounded-lg p-6 w-full max-w-sm shadow-xl"><h3 id="modal-title" class="text-lg font-bold mb-4"></h3><p id="modal-body" class="mb-6 text-gray-300"></p><div class="flex justify-end gap-4"><button id="modal-cancel-btn" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 text-white transition-colors">Cancelar</button><button id="modal-confirm-btn" class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white transition-colors">Confirmar</button></div></div>
    </div>
    
    <div id="edit-prompt-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-[#2a2a2a] rounded-lg p-6 shadow-xl flex flex-col resize overflow-auto" style="width: 60vw; height: 75vh; min-width: 450px; min-height: 400px;">
            <h3 class="text-xl font-bold mb-4 text-white">Editar Prompt</h3>
            <div class="mb-4"><label for="edit-prompt-title" class="block text-sm font-medium text-gray-300 mb-1">Título</label><input type="text" id="edit-prompt-title" class="w-full bg-[#333] border border-[#555] rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div class="flex-grow mb-4 flex flex-col"><label for="edit-prompt-text" class="block text-sm font-medium text-gray-300 mb-1">Texto del Prompt</label><textarea id="edit-prompt-text" class="w-full flex-grow bg-[#333] border border-[#555] rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea></div>
            
            <div class="mt-4 border-t border-gray-600 pt-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Archivo adjunto (Opcional)</label>
                <div class="flex items-center gap-3">
                    <label class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold py-2 px-3 rounded-lg cursor-pointer transition-colors">
                        <span>Seleccionar...</span>
                        <input type="file" id="edit-prompt-file" class="hidden" accept=".txt,.jpg,.jpeg,.png,.gif,.webp,.pdf">
                    </label>
                    <span id="file-name-display" class="text-gray-400 text-sm truncate max-w-xs">Ningún archivo seleccionado.</span>
                    <button id="remove-file-btn" class="hidden p-1 text-gray-400 hover:text-red-400 ml-auto" title="Quitar archivo actual"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-6"><button id="edit-modal-cancel-btn" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 text-white transition-colors">Cancelar</button><button id="edit-modal-save-btn" class="py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition-colors">Guardar Cambios</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'promptManagerData_v2';
            let state = {
                data: { folders: [], prompts: [] },
                selectedFolderId: null,
                viewMode: 'grid', // 'grid' o 'list'
                expandedFolderIds: [],
                draggedItem: null,
                clickTimer: null,
            };

            function loadData() {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    state.data = parsedData.data;
                    state.viewMode = parsedData.viewMode || 'grid';
                    state.expandedFolderIds = parsedData.expandedFolderIds || [];
                } else {
                    const initialFolderId = crypto.randomUUID();
                    state.data = {
                        folders: [{ id: initialFolderId, name: 'General', color: '#888888', order: 0 }],
                        prompts: [],
                    };
                    state.expandedFolderIds.push(initialFolderId);
                    saveState();
                }
                if (!state.selectedFolderId && state.data.folders.length > 0) {
                    state.selectedFolderId = state.data.folders.sort((a,b) => a.order - b.order)[0].id;
                }
            }

            function saveState() {
                const dataToSave = {
                    data: state.data,
                    viewMode: state.viewMode,
                    expandedFolderIds: state.expandedFolderIds
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            }

            function render() {
                renderFolders();
                renderPrompts();
                updateMessages();
                updateViewModeButtons();
                lucide.createIcons();
            }

            function renderFolders() {
                const folderListEl = document.getElementById('folder-list');
                folderListEl.innerHTML = '';
                state.data.folders.sort((a, b) => a.order - b.order).forEach(folder => {
                    const isExpanded = state.expandedFolderIds.includes(folder.id);
                    const folderWrapper = document.createElement('div');
                    folderWrapper.className = `folder-wrapper mb-1 ${isExpanded ? 'is-expanded' : ''}`;
                    folderWrapper.dataset.id = folder.id;
                    folderWrapper.dataset.type = 'folder-wrapper';

                    const header = document.createElement('div');
                    header.className = `folder-item-header flex items-center p-2 rounded-lg cursor-pointer ${state.selectedFolderId === folder.id ? 'bg-blue-600/30 border-blue-500' : ''}`;
                    header.draggable = true;
                    header.dataset.id = folder.id;
                    header.dataset.type = 'folder';
                    header.innerHTML = `
                        <i data-lucide="chevron-right" class="folder-chevron mr-2 flex-shrink-0"></i>
                        <span class="w-2 h-2 rounded-full mr-2 flex-shrink-0" style="background-color: ${folder.color};"></span>
                        <span class="folder-name font-medium text-sm truncate flex-grow">${folder.name}</span>
                        <div class="color-picker ml-2"><input type="color" value="${folder.color}" class="folder-color-input"></div>
                    `;

                    const promptsInFolder = state.data.prompts.filter(p => p.folderId === folder.id).sort((a,b) => a.order - b.order);
                    const promptsList = document.createElement('div');
                    promptsList.className = 'folder-prompts-list';
                    if (promptsInFolder.length > 0) {
                        promptsInFolder.forEach(p => {
                            promptsList.innerHTML += `<div class="prompt-title-in-folder" data-prompt-id="${p.id}">${p.title}</div>`;
                        });
                    }

                    folderWrapper.appendChild(header);
                    folderWrapper.appendChild(promptsList);
                    folderListEl.appendChild(folderWrapper);

                    header.querySelector('.folder-color-input').addEventListener('change', (e) => handleColorChange(e, folder.id));
                    header.addEventListener('click', (e) => handleFolderClick(e, folder.id));
                    header.addEventListener('dblclick', (e) => handleFolderDblClick(e, folder.id));
                    header.addEventListener('dragstart', handleDragStart);
                    header.addEventListener('dragover', handleDragOver);
                    header.addEventListener('dragleave', handleDragLeave);
                    header.addEventListener('drop', handleDrop);
                    
                    promptsList.querySelectorAll('.prompt-title-in-folder').forEach(el => {
                        el.addEventListener('click', (e) => {
                            e.stopPropagation();
                            state.selectedFolderId = folder.id;
                            render();
                            const promptCard = document.querySelector(`.prompt-card[data-id="${el.dataset.promptId}"]`);
                            if(promptCard) {
                                promptCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                promptCard.classList.add('border-blue-500', 'scale-105');
                                setTimeout(() => promptCard.classList.remove('border-blue-500', 'scale-105'), 1500);
                            }
                        });
                    });
                });
            }
            
            function renderPrompts() {
                const grid = document.getElementById('prompts-grid');
                grid.className = state.viewMode === 'list' ? 'prompts-list-view' : 'prompts-grid-view grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
                const searchInput = document.getElementById('search-input').value.toLowerCase();
                grid.innerHTML = '';

                let promptsToRender = state.data.prompts
                    .filter(p => p.folderId === state.selectedFolderId)
                    .sort((a, b) => a.order - b.order)
                    .filter(p => searchInput ? (p.title.toLowerCase().includes(searchInput) || p.text.toLowerCase().includes(searchInput)) : true);

                promptsToRender.forEach(prompt => {
                    const card = document.createElement('div');
                    card.className = 'prompt-card bg-[#222] rounded-lg flex flex-col p-4 transition-all';
                    card.dataset.id = prompt.id;
                    card.dataset.type = 'prompt';
                    card.draggable = true;

                    card.innerHTML = `
                        <div class="prompt-card-content flex-grow overflow-hidden">
                            <h3 class="prompt-title font-bold text-white truncate mb-2">${prompt.title}</h3>
                            <p class="prompt-text text-sm text-gray-400" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">${prompt.text}</p>
                        </div>
                        <div class="prompt-actions flex items-center justify-end gap-2 mt-4">
                             ${prompt.fileData ? `<button class="details-prompt-btn flex items-center gap-1.5 py-1 px-2 text-xs text-gray-300 bg-gray-700/50 hover:bg-gray-600/50 rounded-md" title="Ver archivo: ${prompt.fileName}"><i data-lucide="paperclip" class="w-3 h-3"></i>Más detalles</button>` : ''}
                            <button class="copy-prompt-btn p-2 text-gray-400 hover:text-blue-400" title="Copiar"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            <button class="delete-prompt-btn p-2 text-gray-400 hover:text-red-400" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>`;
                    
                    if (prompt.fileData) {
                       card.querySelector('.details-prompt-btn').addEventListener('click', (e) => {
                           e.stopPropagation();
                           openFileInNewTab(prompt.fileData);
                       });
                    }

                    card.querySelector('.copy-prompt-btn').addEventListener('click', (e) => { e.stopPropagation(); copyToClipboard(prompt.text); });
                    card.querySelector('.delete-prompt-btn').addEventListener('click', (e) => { e.stopPropagation(); showConfirmModal('Eliminar Prompt', `¿Seguro que quieres eliminar "${prompt.title}"?`, () => deletePrompt(prompt.id)); });
                    card.addEventListener('dblclick', () => openEditPromptModal(prompt.id));

                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('drop', handleDrop);
                    grid.appendChild(card);
                });
                updateMessages(promptsToRender.length);
            }
            
            function updateMessages(promptCount) {
                 const noFolderMsg = document.getElementById('no-folder-selected-message'), noPromptsMsg = document.getElementById('no-prompts-message');
                 const promptsContainer = document.getElementById('prompts-grid'), folderTitle = document.getElementById('current-folder-title');
                 if (!state.selectedFolderId) {
                    noFolderMsg.classList.remove('hidden');
                    noPromptsMsg.classList.add('hidden');
                    promptsContainer.classList.add('hidden');
                    folderTitle.textContent = '';
                 } else {
                    noFolderMsg.classList.add('hidden');
                    promptsContainer.classList.remove('hidden');
                    const folder = state.data.folders.find(f => f.id === state.selectedFolderId);
                    folderTitle.textContent = folder ? folder.name : '';
                    noPromptsMsg.classList.toggle('hidden', promptCount > 0 || document.getElementById('search-input').value);
                 }
            }

            function setupUI() {
                document.getElementById('toggle-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('sidebar-collapsed'));
                document.getElementById('add-folder-btn').addEventListener('click', addFolder);
                document.getElementById('delete-folder-btn').addEventListener('click', () => {
                    if (state.selectedFolderId) {
                        const folder = state.data.folders.find(f => f.id === state.selectedFolderId);
                        showConfirmModal('Eliminar Carpeta', `¿Seguro que quieres eliminar la carpeta "${folder.name}" y todos sus prompts?`, () => deleteFolder(state.selectedFolderId));
                    } else showToast('Selecciona una carpeta para eliminar.', true);
                });
                document.getElementById('add-prompt-btn').addEventListener('click', addPrompt);
                document.getElementById('sort-prompts-btn').addEventListener('click', sortPrompts);
                document.getElementById('search-input').addEventListener('input', renderPrompts);
                document.getElementById('view-grid-btn').addEventListener('click', () => setViewMode('grid'));
                document.getElementById('view-list-btn').addEventListener('click', () => setViewMode('list'));
            }

            function setViewMode(mode) {
                state.viewMode = mode;
                saveState();
                render();
            }

            function updateViewModeButtons() {
                document.getElementById('view-grid-btn').classList.toggle('active', state.viewMode === 'grid');
                document.getElementById('view-list-btn').classList.toggle('active', state.viewMode === 'list');
            }

            function handleFolderClick(e, folderId) {
                if (e.target.closest('.color-picker')) return;
                clearTimeout(state.clickTimer);
                state.clickTimer = setTimeout(() => {
                    if(e.target.closest('.folder-chevron')){ 
                         toggleFolderExpansion(folderId);
                    } else { 
                        state.selectedFolderId = folderId;
                        render();
                    }
                }, 200);
            }

            function handleFolderDblClick(e, folderId) {
                clearTimeout(state.clickTimer);
                if (e.target.closest('.color-picker') || e.target.closest('.folder-chevron')) return;
                const nameSpan = e.currentTarget.querySelector('.folder-name');
                if (nameSpan) makeEditable(nameSpan, 'folder', folderId);
            }
            
            function toggleFolderExpansion(folderId) {
                const index = state.expandedFolderIds.indexOf(folderId);
                if (index > -1) state.expandedFolderIds.splice(index, 1);
                else state.expandedFolderIds.push(folderId);
                saveState();
                renderFolders(); 
                lucide.createIcons();
            }
            
            function openEditPromptModal(promptId) {
                const prompt = state.data.prompts.find(p => p.id === promptId);
                if (!prompt) return;
            
                const modal = document.getElementById('edit-prompt-modal');
                const titleInput = document.getElementById('edit-prompt-title');
                const textInput = document.getElementById('edit-prompt-text');
                const saveBtn = document.getElementById('edit-modal-save-btn');
                const cancelBtn = document.getElementById('edit-modal-cancel-btn');
                const fileInput = document.getElementById('edit-prompt-file');
                const fileNameDisplay = document.getElementById('file-name-display');
                const removeFileBtn = document.getElementById('remove-file-btn');
            
                let fileToSave = null;
                let fileShouldBeRemoved = false;
            
                titleInput.value = prompt.title;
                textInput.value = prompt.text;
                fileInput.value = '';
            
                const updateFileDisplay = (fileName) => {
                    if (fileName) {
                        fileNameDisplay.textContent = fileName;
                        removeFileBtn.classList.remove('hidden');
                    } else {
                        fileNameDisplay.textContent = 'Ningún archivo seleccionado.';
                        removeFileBtn.classList.add('hidden');
                        fileInput.value = '';
                        fileToSave = null;
                    }
                     lucide.createIcons();
                };
            
                updateFileDisplay(prompt.fileName);
            
                const fileChangeHandler = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        fileToSave = file;
                        fileShouldBeRemoved = false;
                        updateFileDisplay(file.name);
                    }
                };
            
                const removeFileHandler = () => {
                    fileShouldBeRemoved = true;
                    fileToSave = null;
                    updateFileDisplay(null);
                };
            
                fileInput.addEventListener('change', fileChangeHandler);
                removeFileBtn.addEventListener('click', removeFileHandler);
                modal.classList.remove('hidden');
            
                const saveHandler = async () => {
                    prompt.title = titleInput.value.trim();
                    prompt.text = textInput.value.trim();
            
                    if (fileShouldBeRemoved) {
                        prompt.fileData = null;
                        prompt.fileName = null;
                        prompt.fileType = null;
                    }
            
                    if (fileToSave) {
                        try {
                            const base64String = await readFileAsBase64(fileToSave);
                            prompt.fileData = base64String;
                            prompt.fileName = fileToSave.name;
                            prompt.fileType = fileToSave.type;
                        } catch (error) {
                            showToast('Error al leer el archivo.', true);
                            return; 
                        }
                    }
                    
                    saveState();
                    render();
                    closeModal();
                };
            
                const closeModal = () => {
                    modal.classList.add('hidden');
                    saveBtn.removeEventListener('click', saveHandler);
                    cancelBtn.removeEventListener('click', closeModalHandler);
                    fileInput.removeEventListener('change', fileChangeHandler);
                    removeFileBtn.removeEventListener('click', removeFileHandler);
                };
                
                const closeModalHandler = () => closeModal();
                
                saveBtn.addEventListener('click', saveHandler, { once: true });
                cancelBtn.addEventListener('click', closeModalHandler, { once: true });
            }

            function readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            function openFileInNewTab(fileData) {
                const newTab = window.open();
                if (newTab) {
                    newTab.document.title = "Vista Previa";
                    newTab.document.body.style.margin = '0';
                    newTab.document.body.style.overflow = 'hidden';
                    newTab.document.body.innerHTML = `<iframe src="${fileData}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100vw; height:100vh;" allowfullscreen></iframe>`;
                } else {
                    showToast('Por favor, permite las ventanas emergentes.', true);
                }
            }
            
            function showToast(message, isError = false) { const t = document.getElementById('toast'); t.textContent = message; t.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`; t.classList.remove('opacity-0', 'translate-y-2'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-2'), 3000); }
            function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showToast('¡Copiado al portapapeles!')); }
            function addFolder() { const o = state.data.folders.length > 0 ? Math.max(...state.data.folders.map(f => f.order)) + 1 : 0; const f = {id: crypto.randomUUID(), name: 'Nueva Carpeta', color: '#cccccc', order: o}; state.data.folders.push(f); state.selectedFolderId = f.id; state.expandedFolderIds.push(f.id); saveState(); render(); }
            function deleteFolder(id) { state.data.folders = state.data.folders.filter(f => f.id !== id); state.data.prompts = state.data.prompts.filter(p => p.folderId !== id); if (state.selectedFolderId === id) { state.selectedFolderId = state.data.folders.length > 0 ? state.data.folders.sort((a,b) => a.order - b.order)[0].id : null; } saveState(); render(); }
            function addPrompt() { if (!state.selectedFolderId) { showToast("Selecciona una carpeta.", true); return; } const pInF = state.data.prompts.filter(p => p.folderId === state.selectedFolderId); const o = pInF.length > 0 ? Math.max(...pInF.map(p => p.order)) + 1 : 0; const p = {id: crypto.randomUUID(), title: 'Nuevo Prompt', text: 'Escribe aquí...', folderId: state.selectedFolderId, order: o, fileData: null, fileName: null, fileType: null}; state.data.prompts.push(p); saveState(); render(); openEditPromptModal(p.id); }
            function deletePrompt(id) { state.data.prompts = state.data.prompts.filter(p => p.id !== id); saveState(); render(); }
            function handleColorChange(e, id) { const f = state.data.folders.find(f => f.id === id); if(f) { f.color = e.target.value; saveState(); renderFolders(); lucide.createIcons(); } }
            function sortPrompts() { const pInF = state.data.prompts.filter(p => p.folderId === state.selectedFolderId); pInF.sort((a, b) => a.title.localeCompare(b.title)); pInF.forEach((p, i) => { const oP = state.data.prompts.find(op => op.id === p.id); oP.order = i; }); saveState(); render(); }
            
            // --- DRAG AND DROP ---
            function handleDragStart(e) {
                const draggableTarget = e.target.closest('.folder-item-header, .prompt-card');
                if (draggableTarget) {
                    state.draggedItem = draggableTarget;
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => { state.draggedItem.classList.add('ghost'); }, 0);
                } else {
                    e.preventDefault();
                }
            }

            function handleDragOver(e) {
                e.preventDefault();
                if (!state.draggedItem) return;

                const draggedType = state.draggedItem.dataset.type;
                const dropTarget = e.target.closest('.folder-wrapper, .prompt-card');
                
                if (dropTarget && dropTarget !== state.draggedItem.parentElement && dropTarget !== state.draggedItem) {
                    const dropTargetType = dropTarget.dataset.type;
                    
                    if (draggedType === 'folder' && dropTargetType === 'folder-wrapper') {
                        const folderList = document.getElementById('folder-list');
                        const draggedWrapper = state.draggedItem.parentElement;
                        const rect = dropTarget.getBoundingClientRect();
                        const isAfter = e.clientY > rect.top + rect.height / 2;
                        folderList.insertBefore(draggedWrapper, isAfter ? dropTarget.nextSibling : dropTarget);
                    }
                    
                    if (draggedType === 'prompt' && dropTargetType === 'prompt') {
                        const grid = document.getElementById('prompts-grid');
                        const rect = dropTarget.getBoundingClientRect();
                        const isAfter = e.clientY > rect.top + rect.height / 2;
                        grid.insertBefore(state.draggedItem, isAfter ? dropTarget.nextSibling : dropTarget);
                    }
                }
                
                document.querySelectorAll('.folder-item-header').forEach(f => f.classList.remove('drag-over-folder'));
                const targetFolderHeader = e.target.closest('.folder-item-header');
                if (draggedType === 'prompt' && targetFolderHeader) {
                    targetFolderHeader.classList.add('drag-over-folder');
                }
            }

            function handleDragLeave(e) {
                e.preventDefault();
                const targetFolderHeader = e.target.closest('.folder-item-header');
                if (targetFolderHeader) {
                    targetFolderHeader.classList.remove('drag-over-folder');
                }
            }

            function handleDrop(e) {
                e.preventDefault();
                if (!state.draggedItem) return;

                state.draggedItem.classList.remove('ghost');
                document.querySelectorAll('.drag-over-folder').forEach(el => el.classList.remove('drag-over-folder'));

                const draggedId = state.draggedItem.dataset.id;
                const draggedType = state.draggedItem.dataset.type;
                
                const dropTargetFolderHeader = e.target.closest('.folder-item-header');
                if (draggedType === 'prompt' && dropTargetFolderHeader) {
                    const prompt = state.data.prompts.find(p => p.id === draggedId);
                    const newFolderId = dropTargetFolderHeader.dataset.id;
                    if (prompt && prompt.folderId !== newFolderId) {
                        prompt.folderId = newFolderId;
                        const promptsInNewFolder = state.data.prompts.filter(p => p.folderId === newFolderId && p.id !== draggedId);
                        prompt.order = promptsInNewFolder.length;
                    }
                } else if (draggedType === 'folder') {
                    const folderNodes = document.querySelectorAll('#folder-list .folder-wrapper');
                    folderNodes.forEach((node, index) => {
                        const folder = state.data.folders.find(f => f.id === node.dataset.id);
                        if (folder) folder.order = index;
                    });
                } else if (draggedType === 'prompt') {
                    const promptNodes = document.querySelectorAll('#prompts-grid .prompt-card');
                    promptNodes.forEach((node, index) => {
                        const prompt = state.data.prompts.find(p => p.id === node.dataset.id);
                        if (prompt) prompt.order = index;
                    });
                }

                saveState();
                render();
                state.draggedItem = null;
            }
            
            showConfirmModal = (title, body, onConfirm) => { const m = document.getElementById('confirm-modal'); m.querySelector('#modal-title').textContent = title; m.querySelector('#modal-body').textContent = body; m.classList.remove('hidden'); const cBtn = m.querySelector('#modal-confirm-btn'), aBtn = m.querySelector('#modal-cancel-btn'); const cH = () => { onConfirm(); hM(); }; const hM = () => { m.classList.add('hidden'); cBtn.removeEventListener('click', cH); }; cBtn.addEventListener('click', cH, { once: true }); aBtn.addEventListener('click', hM, { once: true }); };
            makeEditable = (element, type, id) => { const oT = element.textContent; const isTA = type.includes('text'); const i = document.createElement(isTA ? 'textarea' : 'input'); if (!isTA) i.type = 'text'; i.value = oT; i.className = 'editable-input'; if (isTA) { i.style.height = '80px'; i.style.resize = 'vertical'; } element.replaceWith(i); i.focus(); const sC = () => { const nV = i.value.trim(); if (nV && nV !== oT) { if (type === 'folder') { const f = state.data.folders.find(f => f.id === id); if (f) f.name = nV; } saveState(); } render(); }; i.addEventListener('blur', sC); i.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && !isTA) i.blur(); else if (e.key === 'Escape') { i.value = oT; i.blur(); } }); };
            
            function loadAndRender() { loadData(); setupUI(); render(); }
            loadAndRender();
        });
    </script>
</body>
</html>
